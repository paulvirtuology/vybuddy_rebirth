name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
      
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            echo "ðŸš€ Starting backend deployment now..."
            
            # Navigate to repo directory
            cd /home/paul_smartelia/vybuddy_rebirth
            
            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes from main branch..."
            git pull origin main
            
            # Navigate to backend directory
            cd backend

            # Stop and remove containers
            echo "ðŸ›‘ Stopping existing containers..."
            sudo docker-compose down --remove-orphans
            
            # Build and start containers
            echo "ðŸ”¨ Building and starting containers..."
            sudo docker-compose up --build -d
            
            # Show container status
            echo "âœ… Deployment completed!"
            echo "ðŸ“Š Container status:"
            sudo docker-compose ps
            
            # Show recent logs
            echo "ðŸ“‹ Recent logs:"
            sudo docker-compose logs --tail=50
          EOF

